	<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
<head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta name="generator" content="Hugo 0.78.2" />

  
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title> Design &middot; SnabbWall </title>

  
  <link rel="stylesheet" href="http://snabbwall.igalia.com/css/poole.css">
  <link rel="stylesheet" href="http://snabbwall.igalia.com/css/syntax.css">
  <link rel="stylesheet" href="http://snabbwall.igalia.com/css/hyde.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=PT+Sans:400,400italic,700|Abril+Fatface">

  
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/apple-icon-144-precomposed.png">
  <link rel="shortcut icon" href="/favicon.ico">

  
  <link href="" rel="alternate" type="application/rss+xml" title="SnabbWall" />
</head>

	<body class="theme-base-08">
		<div class="sidebar">
  <div class="container sidebar-sticky">
    <div class="sidebar-about">
      <a href="http://snabbwall.igalia.com/"><h1>SnabbWall</h1></a>
      <p class="lead">
       L7 flow filtering 
      </p>
    </div>

    <ul class="sidebar-nav">
      <li><a href="/">Home</a> </li>
      
        <li><a href="/news/"> News </a></li>
      
        <li><a href="/design/"> Design </a></li>
      
        <li><a href="/development/"> Development </a></li>
      
        <li><a href="/guide/"> Guide </a></li>
      
        <li><a href="/roadmap/"> Roadmap </a></li>
      
    </ul>

	<p><img style="display:inline" src="/images/logo32red.png" alt=""></p>
  </div>
</div>


		<div class="content container">
			<div class="post">
			 	<h1>Design</h1>
			      <h2 id="overview">Overview</h2>
<p><!-- raw HTML omitted -->SnabbWall<!-- raw HTML omitted --> is a <em>modular</em>, <em>application-level</em> (Layer-7) firewall <em>suite</em> for <a href="http://snabb.co">Snabb</a>.</p>
<p>As a <em>modular</em> system, it provides a set of components which can be reused in other Snabb designs.</p>
<p>As an <em>application-level</em> (Layer-7) firewall, it is able to:</p>
<ul>
<li>Inspect network traffic and detect flows of related data, and pinpoint which application has produced a certain data flow.</li>
<li>Filter (drop, reject, or accept) packets using criteria specified in a set of rules, which can use the information inferred by inspecting the packets.</li>
</ul>
<p>As a <em>suite</em>, it includes a complete firewall program out of the box.</p>
<h2 id="architecture">Architecture</h2>
<p><!-- raw HTML omitted -->SnabbWall<!-- raw HTML omitted --> takes advantage of the <a href="https://github.com/SnabbCo/snabb/blob/master/src/README.md#introduction">separation in functional components</a>, called <em>applications</em> in Snabb jargon. The following diagram contains a simplified view of the system:</p>
<figure>
    <img src="/images/diagrams/arch-blocks.png"
         alt="Building blocks"/> <figcaption>
            <p>Building blocks</p>
        </figcaption>
</figure>

<p>The main components are <strong>L7 Spy</strong> and <strong>L7 Firewall</strong>, both are Snabb applications:</p>
<ul>
<li><strong>L7 Spy</strong> (or <code>L7spy</code> in short) inspects ingress network traffic, identifies related packets to group them in a <em>related data flow</em>, and —if possible— determines which application has generated the data flow. This is done with the aid of the <a href="http://www.ntop.org/products/deep-packet-inspection/ndpi/">nDPI</a> packet inspection library. The information gathered is attached to each packet as <em>metadata</em>, and the packets are passed through unmodified.</li>
<li><strong>L7 Firewall</strong> (or <code>L7fw</code> in short) receives a set of filtering <em>rules</em>, tries to match ingress packets with each rule, and performs its associated action. The rules can perform matches on the metadata generated by the <em>L7 Spy</em> application.</li>
</ul>
<h2 id="applications">Applications</h2>
<h3 id="l7-spy">L7 Spy</h3>
<figure>
    <img src="/images/diagrams/app-l7spy.png"
         alt="L7 Spy application"/> <figcaption>
            <p>L7 Spy application</p>
        </figcaption>
</figure>

<p>The <strong>L7 Spy</strong> (<code>L7spy</code>) application receives packets from another Snabb application as input, analyzes the packets it receives, and places them unchanged in the output. As a by-product of analyzing the packets, it may generate metadata indicating the kind of application and data payload that the packet contains. This metadata is de-coupled from the original packet data —which remains unchanged— and can be consumed by other Snabb applications-</p>
<p>Each instance of the <code>L7spy</code> application maintain an internal <em>state</em> which is updated as each packet is scanned. It contains information about previously inspected packets which is used to further improve identification of packets in the future. The <em>state</em> is detached from the <code>L7fw</code> application and two (or more) instances can share the same state:</p>
<figure>
    <img src="/images/diagrams/app-l7spy-shared-state.png"
         alt="Using a shared L7 Spy state"/> <figcaption>
            <p>Using a shared L7 Spy state</p>
        </figcaption>
</figure>

<p>The main use case for a the shared <em>state</em> is correlating traffic which belongs to the same application flowing in both “send” and “receive” directions.</p>
<h3 id="l7-firewall">L7 Firewall</h3>
<figure>
    <img src="/images/diagrams/app-l7fw.png"
         alt="L7 Firewall application"/> <figcaption>
            <p>L7 Firewall application</p>
        </figcaption>
</figure>

<p>The <strong>L7 Firewall</strong> (<code>L7fw</code>) application receives packets from another Snabb application as input, applies a set of packet filtering <em>rules</em>, and either <em>drops</em>, <em>rehects</em>, or <em>accepts</em> the packet.</p>
<ul>
<li><em>Dropping</em> a packet plainly ignores it, without forwarding it to the <em>output</em>. The net effect is the same as if the packet were lost.</li>
<li><em>Rejecting</em>, similarly, does not forward it to the <em>output</em>, but the sender of the packet is notified about the inability of delivering the packet by transmitting the appropriate ICMP messages to the sender.</li>
<li><em>Accepting</em> a packet forwards it to the <em>output</em>, effectively letting it pass through the firewall.</li>
</ul>
<p>Note that the application by itself is unidirectional. While this may seem counterintuitive, allows for greater flexibility:</p>
<ul>
<li>Bidirectional filtering —both “send” and “receive” directions— is achieved using two instances with an optionally shared set of <em>rules</em>.</li>
<li>In many scenarios filtering is done in one direction only, and it is possible to use a single instance of the application — with reduced overhead. For example, most —if not all— of the work done by a firewall in front of a server is to only accept packets for the services provided by the server.</li>
</ul>
<h2 id="programs">Programs</h2>
<p>The <!-- raw HTML omitted -->SnabbWall<!-- raw HTML omitted --> suite ships with a ready to use program which uses the <a href="#l7-spy">L7 Spy</a> and <a href="#l7-firewall">L7 Firewall</a> applications to implement a Layer-7 stateful firewall.</p>
<p>This application, runnable using the <code>snabb wall</code> command, includes support for the following features:</p>
<ul>
<li>Loading its configuration and filtering rule sets from from configuration files. The syntax of the configuration files is an <a href="https://en.wikipedia.org/wiki/Domain-specific_language#Usage_patterns">internal DSL</a> based on Lua. This takes advantage of the fact that the language is particularly well suited for <a href="http://www.lua.org/pil/10.1.html">data description</a>.</li>
<li>Support for <em>dropping</em>, <em>rejecting</em>, or <em>accepting</em> packets matched by the filtering rules.</li>
<li>Specifying a default policy (<em>drop</em>, <em>reject</em>, or <em>accept</em>) for packets which are not matched by any of the configured filtering rules.</li>
<li>Optional logging and accounting of matched packets.</li>
<li>Operating in <em>bypass mode</em>: using two physical NIC endpoints at each side, the traffic received from both sides is analyzed using <a href="#l7-spy">L7spy</a>, rules are applied using <a href="#l7-firewall">L7fw</a>, and packets allowed to pass through the firewall are put into the wire at the other side completely unchanged.</li>
<li>Operating in <em>hosted mode</em>: the firewall appears to the host system as a pair of network interfaces (one for each end). In this mode the host system needs to be configured accordingly to forwarding packets into and out of the firewall.</li>
<li>Operating in <em>kitchen sink mode</em>: the firewall passively scans all input packets and gathers information about them, without forwarding them to the output. This can be used together with the logging and accounting support to obtain per-application network statistics.</li>
</ul>

			</div>
		</div>
  </body>
</html>
